<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BLACKPIGEONS — Archive UI (Mono, Depth, Light/Dark, Optimal Layout)</title>
<style id="theme-style">
  :root {
    /* Dark mode variables */
    --bg: #080b12;
    --panel: #10131c;
    --accent: #f6faff;
    --muted: #a3adc3;
    --danger: #ff5b5b;
    --danger-light: #ffb3b3;
    --glass: rgba(255,255,255,0.025);
    --mono: 'JetBrains Mono', 'Fira Mono', 'Menlo', 'Consolas', 'Liberation Mono', 'DejaVu Sans Mono', 'Lucida Console', 'Monaco', 'monospace';
    --shadow: 0 6px 40px #000c, 0 1.5px 0 #1a1d22;
    --border: #22283d;
    --table-row: #181c2a;
    --tag-bg: rgba(50,60,90,0.13);
    --modal-bg: rgba(18,21,33,0.96);
    --card-glass: rgba(30,33,50,0.98);
    --input-bg: #141b29;
    --input-border: #232843;
    --action-bg: #171e29;
    --action-hover: #d6e6ff;
    --action-hover-text: #212c44;
    --radius: 12px;
    --gap: 18px;
    --pad-main: 34px;
    --pad-table-cell: 13px;
    --pad-header: 20px;
    --pad-footer: 20px;
    --badge-pad: 8px 14px;
  }
  html[data-theme='light'] {
    --bg: #f7f8fc;
    --panel: #fff;
    --accent: #0d2244;
    --muted: #657394;
    --danger: #e03a3a;
    --danger-light: #e68d8d;
    --glass: rgba(0,0,0,0.01);
    --shadow: 0 6px 32px #b7bedb44, 0 1.5px 0 #e9edf7;
    --border: #e1e4ee;
    --table-row: #f4f7fb;
    --tag-bg: rgba(33,50,97,0.07);
    --modal-bg: rgba(250,252,255,0.98);
    --card-glass: #fff;
    --input-bg: #f1f4fa;
    --input-border: #d4d8e2;
    --action-bg: #eaf0fb;
    --action-hover: #0d2244;
    --action-hover-text: #f7f8fc;
    --radius: 12px;
    --gap: 18px;
    --pad-main: 34px;
    --pad-table-cell: 13px;
    --pad-header: 20px;
    --pad-footer: 20px;
    --badge-pad: 8px 14px;
  }
  html,body {
    min-height:100%;
    margin:0;
    background: var(--bg);
    color: var(--accent);
    font-family: var(--mono);
    font-size:16px;
    letter-spacing:0.01em;
    transition: background .35s, color .18s;
  }
  .wrap {
    max-width:1100px;
    margin:46px auto;
    padding:var(--pad-main) var(--pad-main) var(--pad-main) var(--pad-main);
    background: var(--panel);
    border-radius:var(--radius);
    box-shadow: var(--shadow);
    border:1.8px solid var(--border);
    transition: background .35s, box-shadow .18s, border-color .2s;
  }
  header {
    display:flex;
    flex-wrap:wrap;
    gap:var(--gap);
    align-items:flex-end;
    margin-bottom:var(--gap);
    padding-bottom:var(--pad-header);
    border-bottom:1px solid var(--border);
  }
  .logo {
    font-family:var(--mono);
    font-weight:700;
    font-size:24px;
    color:var(--accent);
    display:flex;
    align-items:center;
    gap:12px;
    letter-spacing:0.04em;
    user-select:none;
    padding-bottom: 3px;
  }
  .logo .dot {
    width:13px;
    height:13px;
    background:var(--accent);
    border-radius:3px;
    box-shadow:0 0 10px #3b62ff55;
    opacity: 0.8;
    margin-right:3px;
  }
  .sub {
    color:var(--muted);
    font-size:13px;
    font-family:var(--mono);
    margin-left: 2px;
    margin-bottom: 3px;
  }
  .controls {
    margin-left:auto;
    display:flex;
    gap:13px;
    align-items:center;
    flex-wrap:wrap;
  }
  input.search {
    background:var(--input-bg);
    border:1.6px solid var(--input-border);
    color:var(--accent);
    padding:10px 17px;
    border-radius:8px;
    outline:none;
    width:270px;
    font-family:var(--mono);
    font-size:16px;
    transition:border-color .13s, background .13s;
  }
  input.search:focus {
    border-color:var(--accent);
    background:var(--glass);
  }
  select {
    background:var(--input-bg);
    border:1.6px solid var(--input-border);
    color:var(--muted);
    padding:10px 16px;
    border-radius:8px;
    font-family:var(--mono);
    font-size:16px;
    transition:border-color .13s;
    cursor:pointer;
    min-width:120px;
  }
  select:focus {
    border-color:var(--accent);
    outline:none;
  }
  .theme-toggle {
    background: var(--input-bg);
    border: 1.6px solid var(--input-border);
    color: var(--muted);
    font-family: var(--mono);
    font-size: 16px;
    border-radius: 8px;
    padding: 10px 18px;
    cursor: pointer;
    transition: border-color .13s, background .13s, color .13s;
    margin-left: 18px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .theme-toggle:hover, .theme-toggle:focus {
    border-color:var(--accent);
    color:var(--accent);
    background:var(--tag-bg);
    outline: none;
  }
  .theme-toggle .sun, .theme-toggle .moon {
    font-size: 18px;
    display: inline-block;
    vertical-align: middle;
  }
  main {
    margin-top: var(--gap);
    margin-bottom: var(--gap);
  }
  table {
    width:100%;
    border-collapse:separate;
    border-spacing: 0;
    margin-top:0;
    font-size:16px;
    font-family:var(--mono);
    background:transparent;
    box-shadow: 0 2px 18px #0003;
    border-radius:var(--radius);
    overflow: hidden;
  }
  thead th {
    color:var(--muted);
    text-align:left;
    padding:var(--pad-table-cell) 11px;
    border-bottom:1.6px solid var(--border);
    font-weight:700;
    background:transparent;
    font-size:15px;
    font-family:var(--mono);
    letter-spacing: 0.01em;
  }
  tbody tr {
    transition:background .13s;
    background:transparent;
  }
  tbody tr:hover {
    background:var(--table-row);
  }
  td {
    padding:var(--pad-table-cell) 11px;
    border-bottom:1px solid var(--border);
    vertical-align:middle;
    background:transparent;
    font-family:var(--mono);
  }
  .title {
    color:var(--accent);
    font-weight:700;
    font-family:var(--mono);
    font-size:17px;
    margin-bottom: 2px;
    letter-spacing: 0.01em;
    line-height: 1.22;
    word-break:break-word;
    max-width: 99vw;
  }
  .title.incomplete {color:var(--danger-light);}
  .meta {
    color:var(--muted);
    font-size:13px;
    font-family:var(--mono);
    margin-top: 2px;
    margin-bottom: 0;
    line-height: 1.45;
    word-break:break-word;
    max-width: 99vw;
  }
  .tag {
    display:inline-block;
    padding:3px 13px;
    border-radius:999px;
    background:var(--tag-bg);
    color:var(--muted);
    font-size:12px;
    margin-right:9px;
    font-family:var(--mono);
    margin-bottom: 1px;
  }
  .actions {
    display: flex;
    flex-direction: row;
    gap: 12px;
    align-items: center;
    justify-content: flex-start;
    height: 100%;
    padding: 0;
    margin: 0;
  }
  .actions a,
  .actions .disabled-btn {
    background:var(--action-bg);
    padding:10px 20px;
    border-radius:7px;
    color:var(--muted);
    text-decoration:none;
    border:1.6px solid var(--input-border);
    margin: 0 !important;
    display: inline-block;
    vertical-align: middle;
    box-sizing: border-box;
    font-family:var(--mono);
    font-size: 15px;
    min-width: 80px;
    text-align: center;
    transition: background .13s, color .13s, border-color .13s;
    font-weight: 700;
    letter-spacing: 0.01em;
  }
  .actions a:hover{
    background:var(--action-hover);
    color:var(--action-hover-text);
    border-color:var(--accent);
  }
  .actions .disabled-btn {
    color: var(--danger-light);
    border-color: var(--danger);
    background: #1a0909;
    opacity: 0.7;
    cursor: not-allowed;
    pointer-events: none;
    text-decoration:line-through;
  }
  .actions a:first-child {margin-right:0;}
  footer{
    color:var(--muted);
    font-size:14px;
    margin-top:var(--gap);
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding-top:var(--pad-footer);
    border-top:1.6px solid var(--border);
    font-family:var(--mono);
    background: transparent;
    gap: 15px;
  }
  .badge{
    padding:var(--badge-pad);
    border-radius:8px;
    background:var(--tag-bg);
    font-size:14px;
    color:var(--muted);
    font-family:var(--mono);
    margin-right: 12px;
  }
  .modal{
    position:fixed;inset:0;background:var(--modal-bg);display:none;align-items:center;justify-content:center;padding:18px;z-index:999
  }
  .card{
    width:100%;
    max-width:1100px;
    background:var(--card-glass);
    border-radius:14px;
    box-shadow:0 10px 40px #000a;
    overflow:hidden
  }
  .card .head{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:18px 30px;
    border-bottom:1.5px solid var(--border);
    font-family:var(--mono);
    gap: 12px;
    font-size: 17px;
  }
  .viewer{height:70vh;border:0;width:100%;background:var(--panel);}
  @media (max-width:1100px){
    .wrap {padding:14px 2vw;}
    .card{max-width:99vw;}
    .card .head{padding:14px 2vw;}
    .badge{margin-right: 3px;}
  }
  @media (max-width:720px){
    input.search{width:100%}
    header{flex-direction:column;align-items:flex-start;gap:10px;padding-bottom:12px;}
    .controls{margin-left:0;}
    .actions{gap:7px;}
    .wrap{padding:8px 1vw;}
    .card{max-width:99vw;}
    .card .head{padding:10px 2vw;}
    table{font-size:13px;}
    .badge{margin-right: 0;}
    .title{font-size:14px;}
    .actions a, .actions .disabled-btn{padding:8px 8px;min-width:65px;}
  }
</style>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Fira+Mono:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo"><span class="dot"></span> BLACKPIGEONS</div>
    <div>
      <div class="sub">Archive UI — retro listing • For legal/public-domain content only</div>
    </div>
    <div class="controls">
      <input id="q" class="search" placeholder="Search title, author, tag..." />
      <select id="filterType" title="Filter type">
        <option value="">All types</option>
        <option value="pdf">PDF</option>
        <option value="video">Video</option>
        <option value="zip">Archive</option>
      </select>
      <button id="theme-toggle" class="theme-toggle" title="Toggle light/dark mode">
        <span class="moon" style="display:inline;">🌙</span>
        <span class="sun" style="display:none;">☀️</span>
      </button>
    </div>
  </header>

  <main>
    <table id="list">
      <thead>
        <tr>
          <th style="width:52%">Title</th>
          <th style="width:18%">Size</th>
          <th style="width:10%">Type</th>
          <th style="width:10%">Date</th>
          <th style="width:10%">Actions</th>
        </tr>
      </thead>
      <tbody id="rows">
        <!-- rows injected -->
      </tbody>
    </table>
  </main>

  <footer>
    <div class="badge">Serve only files you own or are public domain / CC</div>
    <div class="sub">Built for GitHub Pages • Internet Archive friendly</div>
  </footer>
</div>

<!-- modal viewer -->
<div id="modal" class="modal" role="dialog" aria-hidden="true">
  <div class="card" role="document">
    <div class="head">
      <div id="modalTitle" style="color:var(--accent);font-weight:700">Viewer</div>
      <div style="display:flex;gap:12px;align-items:center">
        <a id="rawLink" class="actions" target="_blank" rel="noopener" style="margin-right:10px;color:var(--muted);text-decoration:none">Open raw</a>
        <button id="close" class="small">Close</button>
      </div>
    </div>
    <div id="modalBody" style="background:var(--panel);">
      <!-- iframe / video injected -->
    </div>
  </div>
</div>

<script>
const DATA_SRC = './files.json'; // change if needed

const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);
const rows = $('#rows');
const q = $('#q');
const filterType = $('#filterType');
const modal = $('#modal');
const modalBody = $('#modalBody');
const modalTitle = $('#modalTitle');
const rawLink = $('#rawLink');
const themeToggle = $('#theme-toggle');
const moonIcon = themeToggle.querySelector('.moon');
const sunIcon = themeToggle.querySelector('.sun');

let items = [];

// fallback sample if files.json missing
const sample = [
  {"id":"sample-pdf","title":"Sample Public Domain Book","author":"Various","size":"2.1 MB","type":"pdf","date":"2020-05-12","url":"https://archive.org/download/oliver_twist_0810_librivox/oliver_twist_0810.pdf","desc":"Public domain sample"},
  {"id":"sample-video","title":"Sample Lecture","author":"Nobody","size":"120 MB","type":"video","date":"2021-07-01","url":"https://archive.org/download/BigBuckBunny_328/BigBuckBunny_512kb.mp4","desc":"Demo video (public domain style)"},
  {"id":"brokenfile","title":"Broken Example File","author":"Unknown","size":"0 MB","type":"pdf","date":"2025-10-01","url":"https://archive.org/download/nonexistent.pdf","desc":"This file is broken.","status":"error"}
];

async function loadData(){
  try {
    const r = await fetch(DATA_SRC, {cache:'no-store'});
    if(!r.ok) throw new Error('no json');
    items = await r.json();
    if(!Array.isArray(items) || items.length===0) throw 'empty';
  } catch(e){
    console.warn('Could not load files.json — using sample data. Error:', e);
    items = sample;
  }
  render();
}

function render(){
  const query = (q.value || '').trim().toLowerCase();
  const typeF = filterType.value;
  // newest first by date if present
  const sorted = items.slice().sort((a,b)=>{
    if(a.date && b.date) return new Date(b.date) - new Date(a.date);
    return (a.title||'').localeCompare(b.title||'');
  });

  rows.innerHTML = '';
  for(const it of sorted){
    if(typeF && it.type !== typeF) continue;
    if(query){
      const hay = (it.title + ' ' + (it.author||'') + ' ' + (it.desc||'') + ' ' + (it.tags||'')).toLowerCase();
      if(!hay.includes(query)) continue;
    }
    const status = (it.status || '').toLowerCase();
    const isError = status === 'error' || status === 'incomplete';
    const titleClass = "title" + (isError ? " incomplete" : "");
    let actionsHtml;
    if(isError){
      actionsHtml = `
        <span class="disabled-btn">Download</span>
        <span class="disabled-btn">View</span>
      `;
    }else{
      actionsHtml = `
        <a href="${escapeHtml(it.url)}" target="_blank" rel="noopener">Download</a>
        <a href="#" data-id="${escapeHtml(it.id)}" class="view">View</a>
      `;
    }
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <div class="${titleClass}">${escapeHtml(it.title)}</div>
        <div class="meta">${escapeHtml(it.author || '')} • <span class="tag">${escapeHtml(it.tags || it.type || '')}</span> ${escapeHtml(it.desc || '')}</div>
      </td>
      <td>${escapeHtml(it.size || '—')}</td>
      <td>${escapeHtml((it.type||'').toUpperCase())}</td>
      <td>${escapeHtml(it.date || '—')}</td>
      <td>
        <div class="actions">
          ${actionsHtml}
        </div>
      </td>
    `;
    rows.appendChild(tr);
  }

  // attach view handlers
  $$('.view').forEach(a=>{
    a.addEventListener('click', e=>{
      e.preventDefault();
      const id = a.getAttribute('data-id');
      const it = items.find(x=>x.id===id);
      if(it) openViewer(it);
    });
  });
}

function openViewer(it){
  modalTitle.textContent = it.title + (it.author ? ' — ' + it.author : '');
  rawLink.href = it.url;
  rawLink.textContent = 'Open raw';
  modalBody.innerHTML = '';

  if(it.type === 'pdf'){
    const ifr = document.createElement('iframe');
    ifr.src = it.url;
    ifr.className = 'viewer';
    ifr.setAttribute('allowfullscreen','');
    modalBody.appendChild(ifr);
  } else if(it.type === 'video'){
    const v = document.createElement('video');
    v.className = 'viewer';
    v.controls = true;
    const src = document.createElement('source');
    src.src = it.url;
    src.type = 'video/mp4';
    v.appendChild(src);
    modalBody.appendChild(v);
  } else {
    modalBody.innerHTML = `<div style="padding:18px;color:var(--muted)">No inline viewer for this file type. <a href="${it.url}" target="_blank" rel="noopener">Open raw</a></div>`;
  }

  modal.style.display = 'flex';
  modal.setAttribute('aria-hidden','false');
}

$('#close').addEventListener('click',()=>closeModal());
modal.addEventListener('click', e => { if(e.target===modal) closeModal(); });
function closeModal(){
  modal.style.display = 'none';
  modalBody.innerHTML = '';
  modal.setAttribute('aria-hidden','true');
}

q.addEventListener('input', render);
filterType.addEventListener('change', render);

// THEME TOGGLE
function setTheme(mode) {
  document.documentElement.setAttribute('data-theme', mode);
  if (mode === 'light') {
    sunIcon.style.display = 'inline';
    moonIcon.style.display = 'none';
    localStorage.setItem('theme', 'light');
  } else {
    sunIcon.style.display = 'none';
    moonIcon.style.display = 'inline';
    localStorage.setItem('theme', 'dark');
  }
}
// Detect preferred theme
(function(){
  let theme = localStorage.getItem('theme');
  if (!theme) {
    theme = window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
  }
  setTheme(theme);
})();
themeToggle.addEventListener('click', function() {
  setTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
});

// small helper to avoid XSS via inserted text
function escapeHtml(s){
  if(!s) return '';
  return String(s).replace(/[&<>"']/g, function(m){
    return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
  });
}

// initial load
loadData();
</script>
</body>
</html>
